<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mudae Note Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0f;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .container {
            max-width: 1540px;
            width: 100%;
            background: #13131a;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            padding: 30px;
            border: 1px solid #1f1f2e;
        }

        .header-row {
            margin-bottom: 25px;
        }

        h1 {
            color: #a78bfa;
            margin-bottom: 10px;
            font-size: 2em;
        }

        h2 {
            color: #a78bfa;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #9ca3af;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .instructions {
            margin-top: 10px;
            font-size: 0.8em;
            color: #6b7280;
            line-height: 1.6;
        }

        .quick-notes {
            background: #13131a;
            border-radius: 15px;
            padding: 20px;
            width: 280px;
            border: 1px solid #1f1f2e;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            position: fixed;
            right: 20px;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
        }

        .quick-notes-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #a78bfa;
            margin-bottom: 15px;
        }

        .quick-notes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .quick-note {
            background: #1a1a24;
            border: 2px solid #7c3aed;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #e5e7eb;
        }

        .quick-note:hover {
            background: #7c3aed;
            color: white;
        }

        .quick-note-remove {
            font-size: 0.8em;
            margin-left: 3px;
            opacity: 0.6;
        }

        .quick-note-remove:hover {
            opacity: 1;
        }

        .add-note-container {
            display: flex;
            gap: 5px;
        }

        .add-note-input {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #2a2a3a;
            border-radius: 5px;
            font-size: 0.9em;
            background: #0a0a0f;
            color: #e5e7eb;
        }

        .add-note-btn {
            padding: 6px 15px;
            font-size: 0.9em;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .input-section {
            margin-bottom: 30px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 8px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #2a2a3a;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            background: #0a0a0f;
            color: #e5e7eb;
        }

        textarea:focus {
            outline: none;
            border-color: #7c3aed;
        }

        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        button:hover {
            background: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }

        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
        }

        .series-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .series-card {
            background: #1a1a24;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #2a2a3a;
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .series-title {
            font-weight: 600;
            color: #e5e7eb;
            font-size: 0.95em;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .series-toggle-btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .series-toggle-btn:hover {
            transform: translateY(-2px);
        }

        .series-toggle-btn.disabled {
            background: #dc2626;
        }

        .series-toggle-btn.disabled:hover {
            background: #b91c1c;
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4);
        }

        .series-count {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .note-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #2a2a3a;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
            background: #0a0a0f;
            color: #e5e7eb;
        }

        .note-input:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .characters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .character-card {
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            width: 140px;
        }

        .character-card:hover {
            transform: scale(1.05);
        }

        .character-card.excluded {
            opacity: 0.4;
        }

        .character-card.excluded img {
            filter: grayscale(100%);
        }

        .character-card img {
            width: 135px;
            height: 210px;
            object-fit: cover;
            display: block;
        }

        .character-card.permanently-disabled {
            position: relative;
            opacity: 0.75;
        }

        .character-card.permanently-disabled::after {
            content: '';
            position: absolute;
            top: 35%;
            left: 5%;
            right: 5%;
            height: 5px;
            background: #dc2626;
            transform: translateY(-50%) rotate(-45deg);
            z-index: 10;
            border-radius: 2px;
            box-shadow: 0 0 5px rgba(220, 38, 38, 0.8);
        }

        .character-card.permanently-disabled .character-info::after {
            content: '';
            position: absolute;
            top: 35%;
            left: 5%;
            right: 5%;
            height: 5px;
            background: #dc2626;
            transform: translateY(-50%) rotate(45deg);
            z-index: 10;
            border-radius: 2px;
            box-shadow: 0 0 5px rgba(220, 38, 38, 0.8);
        }

        .character-info {
            background: #0a0a0f;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .character-name {
            color: #e5e7eb;
            font-size: 0.7em;
            text-align: center;
            word-break: break-word;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .character-stats {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            font-size: 0.65em;
        }

        .stat-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .stat-badge-label {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .stat-badge-value {
            color: #a78bfa;
            font-weight: 700;
        }

        .commands-section {
            margin-top: 30px;
            padding: 20px;
            background: #1a1a24;
            border-radius: 10px;
            border: 1px solid #2a2a3a;
        }

        .command-item {
            background: #13131a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #7c3aed;
        }

        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .command-series {
            font-weight: 600;
            color: #e5e7eb;
        }

        .command-text {
            background: #0a0a0f;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            margin-bottom: 10px;
            color: #d1d5db;
            border: 1px solid #2a2a3a;
        }

        .copy-btn {
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #1a1a24;
            border-radius: 8px;
            border: 1px solid #2a2a3a;
        }

        .stat-item {
            flex: 1;
        }

        .stat-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #a78bfa;
        }

        .error-message {
            background: #7f1d1d;
            color: #fecaca;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
        }

        .success-message {
            background: #064e3b;
            color: #6ee7b7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
        }

        .empty-message {
            display: none;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.85em;
            margin-top: 40px;
            border-top: 1px solid #2a2a3a;
        }

        .footer-contact {
            margin-top: 10px;
            font-size: 0.9em;
        }

        .footer-contact strong {
            color: #a78bfa;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-row">
            <h1>Mudae Note Manager</h1>
            <p class="subtitle">Parse your $mmasi-[y+][k][c+][x+][n] (brackets are optional) output and create note
                commands for
                your characters</p>
            <div class="instructions">
                <div>‚Ä¢ Click characters to disable</div>
                <div>‚Ä¢ Click "Disable All" to toggle entire series</div>
                <div>‚Ä¢ Add notes to group characters</div>
                <div>‚Ä¢ You can also use this to generate $ec commands</div>
            </div>
        </div>

        <div class="input-section">
            <label for="input">Paste your $mmasi-[y+][k][c+][x+][n] (brackets are optional) output here:</label>
            <textarea id="input"
                placeholder="Series Name - 5/20&#10;Character Name - https://mudae.net/uploads/...&#10;Another Character - https://mudae.net/uploads/...&#10;&#10;Another Series - 3/15&#10;Character Name - https://mudae.net/uploads/...&#10;...and so on"></textarea>
            <div style="margin-top: 10px;">
                <button onclick="parseInput()">Parse Input</button>
                <button onclick="clearAll()">Clear All</button>
                <button onclick="generateCommands()" id="generateBtn" disabled>Generate Commands</button>
            </div>
            <div style="margin-top: 10px;">
                <label style="display: inline; margin-right: 10px;">Group by:</label>
                <button onclick="groupBySeries()" disabled>Series</button>
                <button onclick="groupByNote()" disabled>Note</button>
                <button onclick="groupByKeys()" disabled>Keys</button>
            </div>
            <div style="margin-top: 15px;">
                <label style="display: inline; margin-right: 10px;">Sort groupings by:</label>
                <button onclick="sortSeries('alpha')">A-Z</button>
                <button onclick="sortSeries('count')">Character Count</button>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="selectAllCharacters()">Select All</button>
                <button onclick="deselectAllCharacters()">Deselect All</button>
            </div>

        </div>

        <div id="message"></div>

        <div id="stats"></div>

        <div id="seriesGrid" class="series-grid"></div>

        <div id="commands"></div>

        <div class="footer">
            <div class="footer-contact">
                Questions or feedback? Contact <strong>arczeus</strong> on Discord
            </div>
        </div>
    </div>

    <div class="quick-notes">
        <div class="quick-notes-title">Quick Notes</div>
        <div class="quick-notes-list" id="quickNotesList"></div>
        <div class="add-note-container">
            <input type="text" id="newQuickNote" class="add-note-input" placeholder="Add note...">
            <button class="add-note-btn" onclick="addQuickNote()">+</button>
        </div>
    </div>

    <script>
        let seriesData = {};
        let quickNotes = ['‚≠ê', '‚ú®', 'üíï',];

        function initQuickNotes() {
            displayQuickNotes();
        }

        function displayQuickNotes() {
            const list = document.getElementById('quickNotesList');
            list.innerHTML = '';

            const isColorCode = /^#([0-9a-fA-F]{3}){1,2}$/;

            quickNotes.forEach(function (note, idx) {
                const noteEl = document.createElement('div');
                noteEl.className = 'quick-note';
                noteEl.onclick = function (e) {
                    if (!e.target.classList.contains('quick-note-remove')) {
                        copyToClipboard(note);
                    }
                };

                const isColor = isColorCode.test(note);

                if (isColor) {
                    const colorIndicator = document.createElement('div');
                    colorIndicator.className = 'color-indicator';
                    colorIndicator.style.cssText = `background-color: ${note}; width: 12px; height: 12px; border: none;`;
                    noteEl.appendChild(colorIndicator);

                    const noteText = document.createTextNode(note);
                    noteEl.appendChild(noteText);
                } else {
                    const noteText = document.createTextNode(note);
                    noteEl.appendChild(noteText);
                }

                const removeSpan = document.createElement('span');
                removeSpan.className = 'quick-note-remove';
                removeSpan.textContent = '√ó';
                removeSpan.title = 'Remove';
                removeSpan.onclick = function (e) {
                    e.stopPropagation();
                    removeQuickNote(idx);
                };

                noteEl.appendChild(document.createTextNode(' '));
                noteEl.appendChild(removeSpan);
                list.appendChild(noteEl);
            });
        }

        function addQuickNote() {
            const input = document.getElementById('newQuickNote');
            const note = input.value.trim();
            if (note && quickNotes.indexOf(note) === -1) {
                quickNotes.push(note);
                displayQuickNotes();
                input.value = '';
            }
            saveToLocalStorage();
        }

        function removeQuickNote(idx) {
            quickNotes.splice(idx, 1);
            displayQuickNotes();
            saveToLocalStorage();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function () {
                showMessage('Copied: ' + text, 'success');
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            initQuickNotes();
            loadFromLocalStorage();
        });

        function parseInput() {
            const input = document.getElementById('input').value.trim();
            if (!input) {
                showMessage('Please paste your $mmasi-[y+][k][n] (brackets are optional) output first!', 'error');
                return;
            }

            seriesData = {};
            const lines = input.split('\n');
            let currentSeries = null;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                const seriesMatch = line.match(/^(.+?)\s*-\s*(\d+)\/(\d+)$/);
                if (seriesMatch) {
                    currentSeries = seriesMatch[1].trim();
                    seriesData[currentSeries] = {
                        total: parseInt(seriesMatch[3]),
                        owned: parseInt(seriesMatch[2]),
                        characters: [],
                        note: ''
                    };
                } else if (currentSeries) {
                    // General structure: Name [| note] [¬∑ :keytype: (count) (#color)] [kakera ka] - url
                    const charMatch = line.match(/^(.+?)\s+-\s+(https?:\/\/.+)$/);
                    if (charMatch) {
                        let fullInfo = charMatch[1].trim();
                        const imageUrl = charMatch[2].trim();

                        let kakera = '';
                        let keys = '';
                        let color = '';
                        let note = '';
                        let cleanName = fullInfo;
                        let isDisabled = false;

                        // 1. Extract Kakera (always at the end before URL)
                        const kakeraMatch = fullInfo.match(/([\d,]+)\s*ka\s*$/);
                        if (kakeraMatch) {
                            kakera = kakeraMatch[1].replace(/,/g, '');
                            fullInfo = fullInfo.substring(0, kakeraMatch.index).trim();
                        }

                        // 2. Extract Color, Keys, Keytype, Count (part of fullInfo)
                        // This part is the most variable. We'll search for the color pattern (#xxxxxx)
                        const colorMatch = fullInfo.match(/\(#([0-9a-fA-F]{6})\)/);
                        if (colorMatch) {
                            color = '#' + colorMatch[1];
                            fullInfo = fullInfo.replace(colorMatch[0], '').trim();
                        }

                        // 3. Extract Key Count (part of fullInfo, usually after color removal if present)
                        const keysMatch = fullInfo.match(/\((\d+)\)/);
                        if (keysMatch) {
                            keys = keysMatch[1];
                            fullInfo = fullInfo.replace(keysMatch[0], '').trim();
                        }

                        // 4. Clean up Key Type and separator
                        fullInfo = fullInfo.replace(/:(?:bronze|silver|gold|chaos)key:/gi, '').trim();

                        fullInfo = fullInfo.replace(/\(\$toggle[a-zA-Z]+\)/g, '').trim();

                        // Check for the disabled symbol üö´
                        if (fullInfo.includes('üö´')) {
                            isDisabled = true;
                            fullInfo = fullInfo.replace('üö´', '').trim();
                        }

                        fullInfo = fullInfo.replace(/\s*¬∑\s*$/, '').trim();

                        // 5. Extract Name and Note (Name | Note or just Name)
                        const pipeIndex = fullInfo.indexOf('|');
                        if (pipeIndex !== -1) {
                            cleanName = fullInfo.substring(0, pipeIndex).trim();
                            note = fullInfo.substring(pipeIndex + 1).trim();
                        } else {
                            cleanName = fullInfo;
                        }

                        seriesData[currentSeries].characters.push({
                            name: cleanName,
                            displayName: cleanName,
                            image: imageUrl,
                            excluded: false,
                            kakera: kakera,
                            keys: keys,
                            note: note,
                            color: color,
                            isDisabled: isDisabled
                        });
                    }
                }
            }

            if (Object.keys(seriesData).length === 0) {
                showMessage('No valid data found. Please check your input format.', 'error');
                return;
            }

            displaySeries();
            updateStats();
            showMessage('Successfully parsed ' + Object.keys(seriesData).length + ' series!', 'success');
            document.getElementById('generateBtn').disabled = false;
            saveToLocalStorage();
        }

        function sortSeries(method) {
            if (Object.keys(seriesData).length === 0) {
                showMessage('No series to sort!', 'error');
                return;
            }

            const entries = Object.entries(seriesData);

            if (method === 'alpha') {
                entries.sort(function (a, b) {
                    return a[0].localeCompare(b[0]);
                });
                showMessage('Sorted alphabetically', 'success');
            } else if (method === 'count') {
                entries.sort(function (a, b) {
                    return b[1].characters.length - a[1].characters.length;
                });
                showMessage('Sorted by character count', 'success');
            }

            seriesData = {};
            entries.forEach(function (entry) {
                seriesData[entry[0]] = entry[1];
            });

            displaySeries();
            saveToLocalStorage();
        }

        function selectAllCharacters() {
            if (Object.keys(seriesData).length === 0) {
                showMessage('No characters to select!', 'error');
                return;
            }

            for (let seriesName in seriesData) {
                seriesData[seriesName].characters.forEach(function (char) {
                    char.excluded = false;
                });
            }

            displaySeries();
            updateStats();
            saveToLocalStorage();
            showMessage('All characters selected', 'success');
        }

        function deselectAllCharacters() {
            if (Object.keys(seriesData).length === 0) {
                showMessage('No characters to deselect!', 'error');
                return;
            }

            for (let seriesName in seriesData) {
                seriesData[seriesName].characters.forEach(function (char) {
                    char.excluded = true;
                });
            }

            displaySeries();
            updateStats();
            saveToLocalStorage();
            showMessage('All characters deselected', 'success');
        }

        function displaySeries() {
            const grid = document.getElementById('seriesGrid');
            grid.innerHTML = '';

            const seriesEntries = Object.entries(seriesData);
            for (let i = 0; i < seriesEntries.length; i++) {
                const seriesName = seriesEntries[i][0];
                const data = seriesEntries[i][1];
                const card = document.createElement('div');
                card.className = 'series-card';

                const seriesId = seriesName.replace(/[^a-zA-Z0-9]/g, '_');

                const headerDiv = document.createElement('div');
                headerDiv.className = 'series-header';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'series-title';
                titleDiv.textContent = seriesName;
                titleDiv.title = seriesName;

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'series-toggle-btn';
                const allExcluded = data.characters.every(function (c) { return c.excluded; });
                toggleBtn.className += allExcluded ? ' disabled' : '';
                toggleBtn.textContent = allExcluded ? 'Enable All' : 'Disable All';
                toggleBtn.onclick = function (e) {
                    e.stopPropagation();
                    toggleSeries(seriesName);
                };

                const countDiv = document.createElement('div');
                countDiv.className = 'series-count';
                countDiv.textContent = data.owned + '/' + data.total;

                headerDiv.appendChild(titleDiv);
                headerDiv.appendChild(toggleBtn);
                headerDiv.appendChild(countDiv);

                const noteInputContainer = document.createElement('div');
                noteInputContainer.style.cssText = 'display: flex; gap: 5px; margin-bottom: 10px; padding 8px; width: 100%;';

                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.className = 'note-input';
                noteInput.placeholder = 'Enter series note';
                noteInput.value = data.note;
                noteInput.style.flexGrow = '1';
                
                noteInput.onchange = function () {
                    data.note = this.value;
                    saveToLocalStorage(); 
                };

                const applyButton = document.createElement('button');
                applyButton.className = 'series-apply-note-btn';
                applyButton.textContent = 'Apply';
                applyButton.style.cssText = 'background: #7c3aed; border-radius: 5px; padding: 10px; font-size: 0.8em; white-space: nowrap; height: fit-content;';
                applyButton.onclick = function() {
                    updateCharacterNotes(seriesName, data.note);
                };

                noteInputContainer.appendChild(noteInput);
                noteInputContainer.appendChild(applyButton);
                
                const charList = document.createElement('div');
                charList.className = 'characters-list';
                charList.id = 'chars-' + seriesId;

                card.appendChild(headerDiv);
                card.appendChild(noteInputContainer);
                card.appendChild(charList);
                grid.appendChild(card);

                data.characters.forEach(function (char, idx) {
                    const charCard = document.createElement('div');
                    charCard.className = 'character-card' + (char.excluded ? ' excluded' : '');

                    if (char.isDisabled) {
                        charCard.className += ' permanently-disabled';
                    }

                    const colorCode = char.color || '#670d08';
                    charCard.style.borderLeft = '5px solid ' + colorCode;

                    charCard.onclick = function () {
                        toggleCharacter(seriesName, idx);
                    };

                    const img = document.createElement('img');
                    img.src = char.image;
                    img.alt = char.name;
                    img.onerror = function () {
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = 'width: 135px; height: 210px; background: #2a2a3a; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 0.8em; text-align: center; padding: 10px;';
                        placeholder.textContent = 'No Image';
                        this.parentNode.insertBefore(placeholder, this);
                    };

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'character-info';

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'character-name';
                    nameDiv.textContent = char.name;
                    nameDiv.title = char.name;

                    const noteDiv = document.createElement('div');
                    const hasNote = char.note && char.note.trim() !== '';
                    noteDiv.style.cssText = 'background: #0a0a0f; padding: 4px 4px; font-size: 0.7em; color: ' + (hasNote ? '#9ca3af' : '#dc2626; font-weight: bold') + '; text-align: center; word-break: break-word;';
                    noteDiv.textContent = hasNote ? char.note : 'No note!';

                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'character-stats';

                    const kakeraBadge = document.createElement('div');
                    kakeraBadge.className = 'stat-badge';
                    kakeraBadge.innerHTML = '<div class="stat-badge-label">Ka</div><div class="stat-badge-value">' + (char.kakera || '?') + '</div>';

                    const keysBadge = document.createElement('div');
                    keysBadge.className = 'stat-badge';
                    keysBadge.innerHTML = '<div class="stat-badge-label">Keys</div><div class="stat-badge-value">' + (char.keys || '?') + '</div>';

                    statsDiv.appendChild(kakeraBadge);
                    statsDiv.appendChild(keysBadge);

                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(noteDiv);
                    infoDiv.appendChild(statsDiv);


                    charCard.appendChild(img);
                    charCard.appendChild(infoDiv);
                    charList.appendChild(charCard);
                });
            }
        }

        function updateCharacterNotes(seriesName, newNote) {
            if (!seriesData[seriesName]) return;

            seriesData[seriesName].characters.forEach(function (char) {
                char.note = newNote;
            });
            
            displaySeries(); 
            
            saveToLocalStorage();
        }

        function toggleCharacter(seriesName, charIdx) {
            if (seriesData[seriesName] && seriesData[seriesName].characters[charIdx]) {
                const char = seriesData[seriesName].characters[charIdx];
                char.excluded = !char.excluded;

                const seriesId = seriesName.replace(/[^a-zA-Z0-9]/g, '_');
                const charCard = document.querySelector(`#chars-${seriesId} > div:nth-child(${charIdx + 1})`);
                if (charCard) {
                    charCard.classList.toggle('excluded', char.excluded);
                }

                updateSeriesToggleButton(seriesName);

                updateStats();
            }
            saveToLocalStorage();
        }
        function updateSeriesToggleButton(seriesName) {
            const data = seriesData[seriesName];
            const allExcluded = data.characters.every(function (c) { return c.excluded; });

            const grid = document.getElementById('seriesGrid');
            const seriesElements = grid.querySelectorAll('.series-card');
            let toggleBtn;

            for (let i = 0; i < seriesElements.length; i++) {
                const titleDiv = seriesElements[i].querySelector('.series-title');
                if (titleDiv && titleDiv.textContent === seriesName) {
                    toggleBtn = seriesElements[i].querySelector('.series-toggle-btn');
                    break;
                }
            }

            if (toggleBtn) {
                toggleBtn.classList.toggle('disabled', allExcluded);
                toggleBtn.textContent = allExcluded ? 'Enable All' : 'Disable All';
            }
        }
        function toggleSeries(seriesName) {
            if (!seriesData[seriesName]) return;

            const data = seriesData[seriesName];
            const allExcluded = data.characters.every(function (c) {
                return c.excluded;
            });
            const shouldExclude = !allExcluded;

            const seriesId = seriesName.replace(/[^a-zA-Z0-9]/g, '_');
            const charList = document.getElementById('chars-' + seriesId);
            const charCards = charList.querySelectorAll('.character-card');

            data.characters.forEach(function (char, idx) {
                char.excluded = shouldExclude;
                if (charCards[idx]) {
                    charCards[idx].classList.toggle('excluded', shouldExclude);
                }
            });

            updateSeriesToggleButton(seriesName);
            updateStats();
            saveToLocalStorage();
        }

        function updateStats() {
            const totalSeries = Object.keys(seriesData).length;
            let totalChars = 0;
            let includedChars = 0;

            for (let key in seriesData) {
                const data = seriesData[key];
                totalChars += data.characters.length;
                includedChars += data.characters.filter(function (c) { return !c.excluded; }).length;
            }

            const stats = document.getElementById('stats');
            stats.innerHTML = '<div class="stats">' +
                '<div class="stat-item">' +
                '<div class="stat-label">Total Series</div>' +
                '<div class="stat-value">' + totalSeries + '</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="stat-label">Total Characters</div>' +
                '<div class="stat-value">' + totalChars + '</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="stat-label">Included Characters</div>' +
                '<div class="stat-value">' + includedChars + '</div>' +
                '</div>' +
                '</div>';
        }

        function generateCommands() {
            const commandsDiv = document.getElementById('commands');
            commandsDiv.innerHTML = '<div class="commands-section"><h2>Generated Commands</h2></div>';
            const container = commandsDiv.querySelector('.commands-section');

            const noteGroups = {};

            for (let seriesName in seriesData) {
                const data = seriesData[seriesName];
                const includedChars = data.characters.filter(c => !c.excluded);
                if (includedChars.length === 0) continue;

                const note = data.note.trim();
                if (!noteGroups[note]) {
                    noteGroups[note] = [];
                }
                noteGroups[note].push({
                    series: seriesName,
                    characters: includedChars
                });
            }

            for (let note in noteGroups) {
                const seriesList = noteGroups[note];
                const allChars = [];

                for (let s of seriesList) {
                    for (let c of s.characters) {
                        allChars.push(c.name);
                    }
                }

                const noteText = note ? ' ' + note : '';
                const seriesNames = seriesList.map(s => s.series + ' (' + s.characters.length + ')').join(', ');

                let currentCommand = '$n ';
                let commandParts = [];
                for (let i = 0; i < allChars.length; i++) {
                    let next = allChars[i] + '$';
                    if ((currentCommand + next + noteText).length > 2000) {
                        currentCommand += noteText;
                        commandParts.push(currentCommand);
                        currentCommand = '$n ' + allChars[i] + '$';
                    } else {
                        currentCommand += next;
                    }
                }
                if (currentCommand !== '$n ') {
                    currentCommand += noteText;
                    commandParts.push(currentCommand);
                }

                commandParts.forEach((command, idx) => {
                    const commandItem = document.createElement('div');
                    commandItem.className = 'command-item';
                    const seriesBlock = (idx === 0)
                        ? `<div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">${seriesNames}</div>`
                        : '';
                    commandItem.innerHTML = `
                <div class="command-header">
                    <div class="command-series">${note || '(No note)'} - ${allChars.length} character${allChars.length > 1 ? 's' : ''} ${commandParts.length > 1 ? `(Part ${idx + 1}/${commandParts.length})` : ''}</div>
                </div>
                ${seriesBlock}
                <div class="command-text">${command}</div>
                <button class="copy-btn" onclick="copyCommand(this, \`${command.replace(/`/g, '\\`')}\`)">üìã Copy Command</button>
            `;

                    container.appendChild(commandItem);
                });
            }

            if (container.children.length === 1) {
                const p = document.createElement('p');
                p.style.color = '#666';
                p.style.padding = '20px';
                p.textContent = 'No commands to generate. Please select at least one character.';
                container.appendChild(p);
            }
        }

        function copyCommand(btn, command) {
            navigator.clipboard.writeText(command).then(function () {
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#28a745';
                setTimeout(function () {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            });
        }

        function clearAll() {
            if (Object.keys(seriesData).length > 0) {
                if (!confirm('Are you sure you want to clear all data?')) return;
            }

            seriesData = {};
            document.getElementById('input').value = '';
            document.getElementById('seriesGrid').innerHTML = '';
            document.getElementById('commands').innerHTML = '';
            document.getElementById('stats').innerHTML = '';
            document.getElementById('message').innerHTML = '';
            document.getElementById('message').className = 'empty';
            document.getElementById('generateBtn').disabled = true;
            localStorage.removeItem('mudaeSeriesData');
            localStorage.removeItem('mudaeQuickNotes');
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = text;
            setTimeout(function () {
                messageDiv.innerHTML = '';
                messageDiv.className = 'empty-message'
            }, 10000);
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('mudaeSeriesData', JSON.stringify(seriesData));
                localStorage.setItem('mudaeQuickNotes', JSON.stringify(quickNotes));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedSeries = localStorage.getItem('mudaeSeriesData');
                const savedNotes = localStorage.getItem('mudaeQuickNotes');

                if (savedSeries) {
                    seriesData = JSON.parse(savedSeries);
                    displaySeries();
                    updateStats();
                    document.getElementById('generateBtn').disabled = Object.keys(seriesData).length === 0;
                }

                if (savedNotes) {
                    quickNotes = JSON.parse(savedNotes);
                    displayQuickNotes();
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
        }
    </script>
</body>

</html>